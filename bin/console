#!/usr/bin/env php
<?php

declare(strict_types=1);

use Doctrine\Migrations\Tools\Console\Command as MigrationsCommand;
use Doctrine\ORM\Tools\Console\Command as ORMCommand;
use Doctrine\ORM\Tools\Console\EntityManagerProvider\SingleManagerProvider;
use Symfony\Component\Console\Application;

require __DIR__ . '/../vendor/autoload.php';

if (file_exists(__DIR__ . '/../.env')) {
    $dotenv = Dotenv\Dotenv::createImmutable(__DIR__ . '/../');
    $dotenv->load();
}

$containerDefinitions = require __DIR__ . '/../config/container.php';
$container = new DI\Container($containerDefinitions);

$entityManager = $container->get(Doctrine\ORM\EntityManagerInterface::class);

// For ORM commands
$entityManagerProvider = new SingleManagerProvider($entityManager);

// For Migrations commands
$migrationsConfig = new Doctrine\Migrations\Configuration\Migration\PhpFile(__DIR__ . '/../config/migrations.config.php');
$dependencyFactory = Doctrine\Migrations\DependencyFactory::fromEntityManager(
    $migrationsConfig,
    new Doctrine\Migrations\Configuration\EntityManager\ExistingEntityManager($entityManager)
);

$cli = new Application('Personal Site Console');
$cli->setCatchExceptions(true);

// Doctrine ORM Commands
$cli->addCommands([
    new ORMCommand\ClearCache\CollectionRegionCommand($entityManagerProvider),
    new ORMCommand\ClearCache\EntityRegionCommand($entityManagerProvider),
    new ORMCommand\ClearCache\MetadataCommand($entityManagerProvider),
    new ORMCommand\ClearCache\QueryCommand($entityManagerProvider),
    new ORMCommand\ClearCache\QueryRegionCommand($entityManagerProvider),
    new ORMCommand\ClearCache\ResultCommand($entityManagerProvider),
    new ORMCommand\SchemaTool\CreateCommand($entityManagerProvider),
    new ORMCommand\SchemaTool\UpdateCommand($entityManagerProvider),
    new ORMCommand\SchemaTool\DropCommand($entityManagerProvider),
    new ORMCommand\ValidateSchemaCommand($entityManagerProvider),
    new ORMCommand\InfoCommand($entityManagerProvider),
    new ORMCommand\MappingDescribeCommand($entityManagerProvider),
]);

// Doctrine Migrations Commands
$cli->addCommands([
    new MigrationsCommand\DumpSchemaCommand($dependencyFactory),
    new MigrationsCommand\ExecuteCommand($dependencyFactory),
    new MigrationsCommand\GenerateCommand($dependencyFactory),
    new MigrationsCommand\LatestCommand($dependencyFactory),
    new MigrationsCommand\ListCommand($dependencyFactory),
    new MigrationsCommand\MigrateCommand($dependencyFactory),
    new MigrationsCommand\RollupCommand($dependencyFactory),
    new MigrationsCommand\StatusCommand($dependencyFactory),
    new MigrationsCommand\SyncMetadataCommand($dependencyFactory),
    new MigrationsCommand\VersionCommand($dependencyFactory),
    new MigrationsCommand\UpToDateCommand($dependencyFactory),
    new MigrationsCommand\DiffCommand($dependencyFactory),
    new MigrationsCommand\CurrentCommand($dependencyFactory),
]);

// Add your custom commands here
$cli->addCommands([
    new App\Console\CreateUserCommand($entityManager),
]);

$cli->run();
